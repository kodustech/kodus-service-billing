# OpenAPI "Pentest-Ready" Design

Date: 2026-02-05

## Goals

- Provide consistent, secure, pentest-ready OpenAPI documentation without changing runtime behavior.
- Use only `API_DOCS_*` envs for docs configuration.
- Protect `/docs`, `/openapi.json`, and `/docs-json` with Basic Auth + IP allowlist.
- Provide export/lint scripts and helpful tooling (coverage check, Newman summary).

## Chosen Approach

Use `swagger-jsdoc` + `swagger-ui-express` and annotate existing Express routes with `@openapi` JSDoc.

Reasons:
- Keeps docs close to routes without adding decorators or new framework code.
- Avoids DB or app bootstrapping for local export.
- Enables consistent security model in the spec (global Bearer + public exceptions).

## Configuration

All docs config derives from:

- `API_DOCS_ENABLED=true|false` (when false, no docs routes are mounted)
- `API_DOCS_PATH=/docs`
- `API_DOCS_SPEC_PATH=/openapi.json`
- `API_DOCS_IP_ALLOWLIST=103.72.59.0/24` (empty => deny all)
- `API_DOCS_BASIC_USER=dev`
- `API_DOCS_BASIC_PASS=devpass`
- `API_DOCS_SERVER_URLS=https://qa.api.kodus.io|QA`
- `API_DOCS_BASE_URL=http://localhost:3001` (used by export)

## Guards

Central middleware validates:

- IP allowlist (CIDR aware; empty allowlist blocks all).
- Basic Auth (required; empty user/pass blocks all).

This guard is applied to `/docs`, `/openapi.json`, and `/docs-json`.

## OpenAPI Spec

- Global security: `BearerAuth`.
- Public endpoints: `/api/billing/webhook`, `/health`, `/health/ready` with `security: []`.
- All endpoints have `summary` + `description`.
- All responses include schema; all 2xx have schema.
- 400/401/403/500 documented with `ApiErrorDto`.
- No empty DTOs; all schemas have properties.
- Request bodies include examples.
- Query params documented via `parameters`.

## Scripts

- `yarn openapi:export`
  - If `API_DOCS_BASE_URL` set, fetch `${BASE_URL}${API_DOCS_SPEC_PATH}`.
  - Else, generate spec locally via `swagger-jsdoc`.
  - Output: `.openapi/openapi.json`.

- `yarn openapi:lint`
  - Run `redocly lint .openapi/openapi.json`.

## Tooling

- `scripts/validate-openapi-coverage.ts`
  - Compares Express router routes with OpenAPI paths.
- `scripts/summarize-newman.ts`
  - Summarizes Newman JSON output into a concise report.
- `scripts/generate-postman.sh` + `scripts/run-newman.sh`
  - Convert OpenAPI to Postman and execute Newman.
  - Pre-request script injects `NEWMAN_BEARER_TOKEN` if present; otherwise no-op.
