# OpenAPI "Pentest-Ready" Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Add secure, pentest-ready Swagger/OpenAPI documentation with export/lint tooling and no runtime behavior changes.

**Architecture:** Use `swagger-jsdoc` + `swagger-ui-express` with JSDoc annotations on Express routes. A docs guard enforces Basic Auth + IP allowlist and is applied only to docs endpoints. Scripts export/lint the spec and run Postman/Newman utilities.

**Tech Stack:** Express, TypeScript, swagger-jsdoc, swagger-ui-express, ipaddr.js, redocly CLI, openapi-to-postmanv2, Newman.

### Task 1: Add OpenAPI dependencies

**Files:**
- Modify: `package.json`

**Step 1: Write the failing test**

Create a minimal script to assert dependencies are installed (placeholder that will fail before install).

```js
// scripts/openapi/dep-check.js
try { require.resolve("swagger-jsdoc"); process.exit(0); } catch { process.exit(1); }
```

**Step 2: Run test to verify it fails**

Run: `node scripts/openapi/dep-check.js`  
Expected: exit code `1`

**Step 3: Write minimal implementation**

Add deps:

- dependencies: `swagger-jsdoc`, `swagger-ui-express`, `ipaddr.js`
- devDependencies: `@redocly/cli`, `openapi-to-postmanv2`, `newman`

**Step 4: Run test to verify it passes**

Run: `node scripts/openapi/dep-check.js`  
Expected: exit code `0`

**Step 5: Commit**

```bash
git add package.json scripts/openapi/dep-check.js
git commit -m "chore: add openapi tooling dependencies"
```

---

### Task 2: Add docs env parser + access helpers + tests

**Files:**
- Create: `src/config/docs/env.ts`
- Create: `src/config/docs/access.ts`
- Create: `scripts/openapi/access.test.js`

**Step 1: Write the failing test**

```js
// scripts/openapi/access.test.js
const assert = require("assert");
const { parseAllowlist, isIpAllowed, parseBasicAuth } = require("../../src/config/docs/access");

assert.deepStrictEqual(parseAllowlist(""), []);
assert.equal(isIpAllowed("1.1.1.1", []), false);
assert.deepStrictEqual(parseBasicAuth("Basic ZGV2OmRldnBhc3M="), { user: "dev", pass: "devpass" });
```

**Step 2: Run test to verify it fails**

Run: `node scripts/openapi/access.test.js`  
Expected: FAIL (module not found)

**Step 3: Write minimal implementation**

Create helpers:

```ts
// src/config/docs/access.ts
import ipaddr from "ipaddr.js";

export function parseAllowlist(raw: string | undefined): string[] { /* split by comma, trim */ }
export function parseBasicAuth(header?: string): { user: string; pass: string } | null { /* decode Basic */ }
export function isIpAllowed(ip: string, allowlist: string[]): boolean { /* ipaddr.parse, CIDR match */ }
```

Create env parser:

```ts
// src/config/docs/env.ts
export function getDocsEnv() {
  return {
    enabled: process.env.API_DOCS_ENABLED === "true",
    path: process.env.API_DOCS_PATH || "/docs",
    specPath: process.env.API_DOCS_SPEC_PATH || "/openapi.json",
    allowlist: process.env.API_DOCS_IP_ALLOWLIST || "",
    basicUser: process.env.API_DOCS_BASIC_USER || "",
    basicPass: process.env.API_DOCS_BASIC_PASS || "",
    serverUrls: process.env.API_DOCS_SERVER_URLS || "",
    baseUrl: process.env.API_DOCS_BASE_URL || "",
  };
}
```

**Step 4: Run test to verify it passes**

Run: `node scripts/openapi/access.test.js`  
Expected: exit code `0`

**Step 5: Commit**

```bash
git add src/config/docs/env.ts src/config/docs/access.ts scripts/openapi/access.test.js
git commit -m "feat: add api docs env and access helpers"
```

---

### Task 3: Add docs guard middleware

**Files:**
- Create: `src/middlewares/apiDocsGuard.ts`
- Modify: `scripts/openapi/access.test.js`

**Step 1: Write the failing test**

Add a guard behavior test that checks allowlist + basic auth denial.

```js
const { buildDocsGuard } = require("../../src/middlewares/apiDocsGuard");
// use fake req/res to verify 401/403 responses
```

**Step 2: Run test to verify it fails**

Run: `node scripts/openapi/access.test.js`  
Expected: FAIL (module not found or assertion)

**Step 3: Write minimal implementation**

```ts
// src/middlewares/apiDocsGuard.ts
import { getDocsEnv } from "../config/docs/env";
import { isIpAllowed, parseAllowlist, parseBasicAuth } from "../config/docs/access";

export function buildDocsGuard() {
  const { allowlist, basicUser, basicPass } = getDocsEnv();
  const allowed = parseAllowlist(allowlist);
  return (req, res, next) => { /* deny if allowlist empty or no auth */ };
}
```

**Step 4: Run test to verify it passes**

Run: `node scripts/openapi/access.test.js`  
Expected: PASS

**Step 5: Commit**

```bash
git add src/middlewares/apiDocsGuard.ts scripts/openapi/access.test.js
git commit -m "feat: add api docs guard"
```

---

### Task 4: Add OpenAPI spec generator

**Files:**
- Create: `src/config/docs/openapi.ts`
- Create: `scripts/openapi/generate-spec.ts`
- Create: `scripts/openapi/dep-check.js` (if not already)

**Step 1: Write the failing test**

Create a smoke test to ensure spec generation outputs JSON with `openapi`.

```js
const spec = require("../../src/config/docs/openapi").buildOpenApiSpec();
if (!spec || !spec.openapi) process.exit(1);
```

**Step 2: Run test to verify it fails**

Run: `node scripts/openapi/spec.test.js`  
Expected: FAIL (module not found)

**Step 3: Write minimal implementation**

Implement `buildOpenApiSpec()` using swagger-jsdoc, defining:
- `info`, `servers` (from API_DOCS_SERVER_URLS)
- `components.schemas` (ApiErrorDto + DTOs)
- `security` global (Bearer)
- `apis` pointing to `src/routes/**/*.ts`

Add generator script:

```ts
// scripts/openapi/generate-spec.ts
import { buildOpenApiSpec } from "../../src/config/docs/openapi";
// write to .openapi/openapi.json
```

**Step 4: Run test to verify it passes**

Run: `node scripts/openapi/spec.test.js`  
Expected: PASS

**Step 5: Commit**

```bash
git add src/config/docs/openapi.ts scripts/openapi/generate-spec.ts scripts/openapi/spec.test.js
git commit -m "feat: add openapi spec generator"
```

---

### Task 5: Annotate routes with @openapi JSDoc

**Files:**
- Modify: `src/routes/subscription.routes.ts`
- Modify: `src/index.ts` (health routes annotations)

**Step 1: Write the failing test**

Use the coverage script to detect missing paths.

```bash
node scripts/openapi/validate-coverage.js
```

Expected: FAIL (missing paths)

**Step 2: Write minimal implementation**

Add JSDoc `@openapi` blocks for:
- `/api/billing/*` routes (including params, requestBody, responses)
- `/health` and `/health/ready` (public security)

Ensure:
- `summary` + `description` for all endpoints
- `security: []` for public endpoints
- 2xx schema present
- 400/401/403/500 with `ApiErrorDto`

**Step 3: Run test to verify it passes**

Run: `node scripts/openapi/validate-coverage.js`  
Expected: PASS

**Step 4: Commit**

```bash
git add src/routes/subscription.routes.ts src/index.ts
git commit -m "docs: add openapi annotations for routes"
```

---

### Task 6: Add export/lint/postman/newman scripts

**Files:**
- Create: `scripts/openapi/export-openapi.ts`
- Create: `scripts/openapi/generate-postman.sh`
- Create: `scripts/openapi/run-newman.sh`
- Create: `scripts/openapi/summarize-newman.ts`
- Modify: `package.json`
- Modify: `.gitignore`

**Step 1: Write the failing test**

Run: `yarn openapi:export`  
Expected: FAIL (script missing)

**Step 2: Write minimal implementation**

- `openapi:export`: fetch from `API_DOCS_BASE_URL` if set, else use local generator. Output to `.openapi/openapi.json`.
- `openapi:lint`: run `redocly lint .openapi/openapi.json`.
- `openapi:postman`: convert OpenAPI to Postman using `openapi-to-postmanv2`.
- `openapi:newman`: run Newman with optional `NEWMAN_BEARER_TOKEN`.
- `openapi:summary`: summarize Newman JSON output.
- Add `.openapi/` to `.gitignore`.

**Step 3: Run test to verify it passes**

Run: `yarn openapi:export`  
Expected: `.openapi/openapi.json` created

**Step 4: Commit**

```bash
git add package.json scripts/openapi .gitignore
git commit -m "chore: add openapi export/lint/postman scripts"
```

---

### Task 7: Wire docs routes in app + update env example

**Files:**
- Modify: `src/index.ts`
- Modify: `.env.example`

**Step 1: Write the failing test**

Manual check: with `API_DOCS_ENABLED=false`, `/docs` is not mounted.

**Step 2: Write minimal implementation**

In `src/index.ts`:

- If `API_DOCS_ENABLED` true:
  - mount `/docs` via swagger-ui-express
  - mount `/openapi.json` and `/docs-json` with guard

In `.env.example`, add all `API_DOCS_*` entries.

**Step 3: Run test to verify it passes**

Manual: set `API_DOCS_ENABLED=true`, hit `/docs` (guarded).

**Step 4: Commit**

```bash
git add src/index.ts .env.example
git commit -m "feat: wire guarded api docs and env example"
```

---

### Task 8: Final verification

**Step 1: Run lint**

Run: `yarn openapi:lint`  
Expected: PASS

**Step 2: Run build**

Run: `yarn build`  
Expected: PASS

**Step 3: Commit if needed**

```bash
git status -s
```

